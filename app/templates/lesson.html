{% extends "base.html" %}
{% block content %}
  <div class="mb-4">
    <div class="text-zinc-400 text-sm">
      <a class="hover:underline" href="/">Courses</a> /
      <a class="hover:underline" href="/course/{{ course.id }}">{{ course.title }}</a> /
    </div>
    <h1 class="text-2xl font-semibold">{{ lesson.title }}</h1>
    <div class="text-sm text-zinc-500">{{ lesson.section }}</div>
  </div>

  <div class="rounded-lg bg-black border border-zinc-800 overflow-hidden">
    <video id="player" class="w-full" controls playsinline preload="metadata" src="/video/{{ lesson.id }}"></video>
  </div>

  <div class="mt-4 flex items-center gap-3">
    <button id="markDone" class="px-3 py-2 rounded bg-emerald-700 hover:bg-emerald-600 text-sm font-medium">Mark complete</button>
    <div id="status" class="text-xs text-zinc-500"></div>
  </div>

  <script>
    const lessonId = {{ lesson.id }};
    const player = document.getElementById('player');
    const statusEl = document.getElementById('status');
    const markDoneBtn = document.getElementById('markDone');

    const initialPos = {{ (progress.position_seconds if progress else 0.0) | tojson }};
    const initialCompleted = {{ (progress.completed if progress else false) | tojson }};

    let lastSent = 0;

    function sendProgress(payload) {
      return fetch(`/api/progress/${lessonId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        statusEl.textContent = `saved @ ${new Date().toLocaleTimeString()}`;
      }).catch(() => {
        statusEl.textContent = 'save failed';
      });
    }

    player.addEventListener('loadedmetadata', () => {
      if (!initialCompleted && initialPos > 2 && player.duration && initialPos < player.duration - 2) {
        player.currentTime = initialPos;
      }
    });

    player.addEventListener('timeupdate', () => {
      const now = Date.now();
      if (now - lastSent < 5000) return; // throttle
      lastSent = now;
      sendProgress({ position_seconds: player.currentTime, completed: false });
    });

    player.addEventListener('ended', () => {
      sendProgress({ position_seconds: player.duration || player.currentTime, completed: true });
    });

    markDoneBtn.addEventListener('click', () => {
      sendProgress({ position_seconds: player.currentTime, completed: true });
    });
  </script>
{% endblock %}
